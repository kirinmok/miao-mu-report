<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘ç¶“ç†äººå¾Œå° | å®¶æ—æˆ°æƒ…å®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #0b1120;
            color: #e2e8f0;
        }

        .glass {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .input-dark {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px 18px;
            width: 100%;
            transition: all 0.2s;
            color: white;
        }

        .input-dark:focus {
            outline: none;
            border-color: #38bdf8;
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.15);
        }

        .btn-glow {
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: white;
            padding: 12px 24px;
            border-radius: 14px;
            font-weight: 700;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        .btn-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.4);
            filter: brightness(110%);
        }
    </style>
</head>

<body class="min-h-screen p-4 md:p-10 flex flex-col items-center">

    {% if not is_logged_in %}
    <!-- Login View -->
    <div class="glass p-10 rounded-[2rem] shadow-2xl w-full max-w-md mt-20 border border-slate-700/30">
        <div class="text-center mb-10">
            <div class="text-5xl mb-4">ğŸ›¡ï¸</div>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-400">
                ç¶“ç†äººèªè­‰</h1>
            <p class="text-slate-500 mt-2">åªæœ‰è«è€å¸«èƒ½é€²å…¥æ­¤å€åŸŸ</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="bg-red-500/10 border border-red-500/30 text-red-500 px-4 py-3 rounded-xl mb-6 text-sm text-center">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <form action="/login" method="POST" class="space-y-6">
            <input type="text" name="username" required class="input-dark" placeholder="ç®¡ç†å“¡ä»£è™Ÿ">
            <input type="password" name="password" required class="input-dark" placeholder="èªè­‰é‡‘é‘°">
            <button type="submit" class="w-full btn-glow">è§£é–è³‡ç”¢æª”æ¡ˆ</button>
        </form>
    </div>

    {% else %}
    <!-- Dashboard View -->
    <div class="w-full max-w-6xl">
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
            <div class="flex items-center gap-4">
                <div class="bg-blue-500/20 p-3 rounded-2xl text-2xl border border-blue-500/30">ğŸ“Š</div>
                <div>
                    <h1 class="text-2xl font-bold text-white">è³‡ç”¢ç®¡ç†ç³»çµ±</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-slate-500 text-sm">ç›®å‰é¸ä¸­ï¼š</span>
                        <form action="/switch_profile" method="POST" id="profile-form">
                            <select name="profile_name" onchange="this.form.submit()"
                                class="bg-slate-800 text-cyan-400 text-sm font-bold border border-slate-700 rounded-lg px-3 py-1 outline-none">
                                {% for name in assets.keys() %}
                                <option value="{{ name }}" {% if name==current_profile %}selected{% endif %}>{{ name }}
                                </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="saveChanges()" class="btn-glow flex items-center gap-2 text-sm px-6">
                    <span>ğŸ’¾</span> å„²å­˜è®Šæ›´
                </button>
                <a href="/logout"
                    class="bg-slate-800 hover:bg-slate-700 text-slate-400 px-4 py-2 rounded-xl text-sm transition-colors border border-slate-700">å®‰å…¨ç™»å‡º</a>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Stats -->
            <div class="lg:col-span-1 space-y-6">
                <div class="glass p-6 rounded-3xl border-l-4 border-l-emerald-500">
                    <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">æˆå“¡ï¼š{{ current_profile }}
                    </p>
                    <h3 class="text-slate-400 text-sm mb-1">å¯ç”¨ç¾é‡‘é¤˜é¡</h3>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl font-mono text-emerald-400">$</span>
                        <input type="number" id="user-cash" value="{{ user_data.cash }}"
                            class="text-3xl font-mono bg-transparent border-none outline-none w-full text-white"
                            onchange="markDirty()">
                    </div>
                </div>

                <div class="glass p-6 rounded-3xl group">
                    <h3 class="text-slate-400 text-sm font-bold uppercase mb-4">ğŸ“¸ åº«å­˜æˆªåœ–åŒ¯å…¥</h3>
                    <div class="border-2 border-dashed border-slate-700 rounded-2xl p-10 flex flex-col items-center hover:border-blue-500/50 transition-all cursor-pointer relative overflow-hidden"
                        onclick="document.getElementById('file-input').click()">
                        <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">ğŸ“¤</div>
                        <p class="text-xs text-slate-500 text-center">æ”¯æ´ Gemini AI <br>è‡ªå‹•è§£æåº«å­˜</p>
                        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="uploadImage(this)">
                        <div id="loading-overlay"
                            class="absolute inset-0 bg-slate-900/90 flex flex-center items-center justify-center hidden">
                            <div
                                class="animate-spin h-6 w-6 border-2 border-blue-500 border-t-transparent rounded-full">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="lg:col-span-2">
                <div class="glass rounded-3xl p-6 shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-slate-400 text-sm font-bold uppercase">æŒè‚¡æŠ•è³‡æ¸…å–®</h3>
                        <button onclick="addHoldingRow()"
                            class="text-xs text-indigo-400 hover:text-indigo-300 font-bold bg-indigo-500/10 px-4 py-2 rounded-full border border-indigo-500/20">+
                            æ‰‹å‹•æ–°å¢</button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead
                                class="text-slate-600 text-[10px] uppercase font-bold tracking-tighter border-b border-slate-800">
                                <tr>
                                    <th class="px-4 py-3">ä»£è™Ÿ</th>
                                    <th class="px-4 py-3">åç¨±</th>
                                    <th class="px-4 py-3">è‚¡æ•¸</th>
                                    <th class="px-4 py-3">æˆæœ¬</th>
                                    <th class="px-4 py-3 w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="holdings-body" class="divide-y divide-slate-800/50">
                                {% for item in user_data.holdings %}
                                <tr class="holding-row hover:bg-white/5 transition-colors">
                                    <td class="p-2"><input type="text" class="input-dark font-mono text-sm symbol"
                                            value="{{ item.symbol }}"></td>
                                    <td class="p-2"><input type="text" class="input-dark text-sm name"
                                            value="{{ item.name }}"></td>
                                    <td class="p-2"><input type="number" class="input-dark font-mono text-sm shares"
                                            value="{{ item.shares }}"></td>
                                    <td class="p-2"><input type="number" step="0.01"
                                            class="input-dark font-mono text-sm cost" value="{{ item.cost }}"></td>
                                    <td class="p-2"><button onclick="removeRow(this)"
                                            class="text-slate-700 hover:text-red-500 text-xl transition-colors">Ã—</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="toast"
        class="fixed bottom-10 right-10 px-8 py-4 rounded-2xl shadow-xl transform translate-y-32 opacity-0 transition-all duration-500 z-50">
    </div>

    <script>
        let isDirty = false;
        function markDirty() { isDirty = true; }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `fixed bottom-10 right-10 px-8 py-4 rounded-2xl shadow-xl transform transition-all duration-500 z-50 ${type === 'success' ? 'bg-gradient-to-r from-emerald-500 to-teal-600 text-white' : 'bg-red-500 text-white'
                }`;
            toast.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => { toast.classList.add('translate-y-32', 'opacity-0'); }, 3000);
        }

        function addHoldingRow(data = { symbol: '', name: '', shares: 0, cost: 0 }) {
            const tbody = document.getElementById('holdings-body');
            const tr = document.createElement('tr');
            tr.className = 'holding-row hover:bg-white/5 transition-colors';
            tr.innerHTML = `
                <td class="p-2"><input type="text" class="input-dark font-mono text-sm symbol" value="${data.symbol}"></td>
                <td class="p-2"><input type="text" class="input-dark text-sm name" value="${data.name}"></td>
                <td class="p-2"><input type="number" class="input-dark font-mono text-sm shares" value="${data.shares}"></td>
                <td class="p-2"><input type="number" step="0.01" class="input-dark font-mono text-sm cost" value="${data.cost}"></td>
                <td class="p-2"><button onclick="removeRow(this)" class="text-slate-700 hover:text-red-500 text-xl transition-colors">Ã—</button></td>
            `;
            tbody.insertAdjacentElement('afterbegin', tr);
            markDirty();
        }

        function removeRow(btn) { btn.closest('tr').remove(); markDirty(); }

        async function saveChanges() {
            const cash = parseFloat(document.getElementById('user-cash').value) || 0;
            const holdings = [];
            document.querySelectorAll('.holding-row').forEach(row => {
                const symbol = row.querySelector('.symbol').value.trim();
                const name = row.querySelector('.name').value.trim();
                const shares = parseInt(row.querySelector('.shares').value) || 0;
                const cost = parseFloat(row.querySelector('.cost').value) || 0;
                if (symbol) holdings.push({ symbol, name, shares, cost });
            });

            const res = await fetch('/update_assets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cash, holdings })
            });

            if (res.ok) { showToast('âœ… é›²ç«¯åŒæ­¥å®Œæˆ'); isDirty = false; }
            else { showToast('âŒ å„²å­˜å¤±æ•—', 'error'); }
        }

        async function uploadImage(input) {
            if (!input.files || !input.files[0]) return;
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.remove('hidden');

            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const res = await fetch('/upload_screenshot', { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success && result.holdings.length > 0) {
                    result.holdings.forEach(item => addHoldingRow(item));
                    showToast(`ğŸ¤– AI å·²è‡ªå‹•è¾¨è­˜ ${result.holdings.length} ç­†æŒè‚¡`);
                } else { showToast('âš ï¸ æœªèƒ½è¾¨è­˜åº«å­˜è³‡è¨Š', 'error'); }
            } catch (e) { showToast('âŒ é€£ç·šéŒ¯èª¤', 'error'); }
            finally { overlay.classList.add('hidden'); input.value = ''; }
        }

        window.onbeforeunload = function () { if (isDirty) return "è®Šæ›´å°šæœªå„²å­˜ï¼"; };
    </script>
</body>

</html>