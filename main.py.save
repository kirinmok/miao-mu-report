from FinMind.data import DataLoader
from datetime import datetime, timedelta
import time

class SimpleAnalyzer:
    @staticmethod
    def analyze_stock(stock_id, stock_name):
        print(f"\n{'='*60}")
        print(f"æ­£åœ¨åˆ†æ: {stock_name} ({stock_id})")
        print(f"{'='*60}\n")
        
        try:
            print("ğŸ“Š æ­£åœ¨ç²å–è‚¡åƒ¹æ•¸æ“š...")
            end_date = datetime.now().strftime('%Y-%m-%d')
            start_date = (datetime.now() - timedelta(days=90)).strftime('%Y-%m-%d')
            
            df_price =DataLoader ().taiwan_stock_daily(
                stock_id=stock_id,
                start_date=start_date,
                end_date=end_date
            )
            
            if df_price.empty:
                print(f"âŒ ç„¡æ³•ç²å–{stock_name}çš„è‚¡åƒ¹æ•¸æ“š\n")
                return None
            
            latest_price = df_price.iloc[-1]['close']
            price_change = ((latest_price - df_price.iloc[0]['close']) / df_price.iloc[0]['close']) * 100
            
            print(f"âœ… æˆåŠŸç²å– {len(df_price)} å¤©çš„æ•¸æ“š")
            print(f"   æœ€æ–°æ”¶ç›¤åƒ¹: {latest_price:.2f}")
            print(f"   è¿‘90å¤©æ¼²è·Œ: {price_change:+.2f}%\n")
            
            score = 5.0
            if price_change > 10:
                score += 1.5
            elif price_change > 0:
                score += 0.5
            
            score = max(1, min(10, score))
            
            if score >= 7:
                recommendation = "ğŸŸ¢ å¯ä»¥è€ƒæ…®è²·å…¥"
            elif score >= 5:
                recommendation = "ğŸŸ¡ æŒæœ‰è§€æœ›"
            else:
                recommendation = "ğŸ”´ è€ƒæ…®è³£å‡º"
            
            print(f"{'â”€'*60}")
            print(f"ğŸ“Š è©•åˆ†: {score:.1f}/10")
            print(f"ğŸ’¡ å»ºè­°: {recommendation}")
            print(f"{'='*60}\n")
            
            return {
                'stock_id': stock_id,
                'stock_name': stock_name,
                'score': score,
                'recommendation': recommendation,
                'latest_price': latest_price,
                'price_change': price_change
            }
            
        except Exception as e:
            print(f"âŒ éŒ¯èª¤: {e}\n")
            return None

def main():
    print("\n" + "="*60)
    print("     è‚¡ç¥¨åˆ†æç³»çµ± v1.0")
    print("="*60 + "\n")
    
    test_portfolio = [
        ("2330", "å°ç©é›»"),
        ("1303", "å—äº"),
        ("2317", "é´»æµ·"),
    ]
    
    results = []
    for stock_id, stock_name in test_portfolio:
        result = SimpleAnalyzer.analyze_stock(stock_id, stock_name)
        if result:
            results.append(result)
        time.sleep(1)
    
    if results:
        print("\n" + "="*60)
        print("           ç¸½çµå ±å‘Š")
        print("="*60 + "\n")
        results.sort(key=lambda x: x['score'], reverse=True)
        for i, r in enumerate(results, 1):
            print(f"{i}. {r['stock_name']}({r['stock_id']}): {r['score']:.1f}/10 - {r['recommendation']}")
        print("\n")

if __name__ == "__main__":
    main()
