import os
import time
import requests
import pandas as pd
import pandas_ta as ta
from datetime import datetime, timedelta
from FinMind.data import DataLoader

# ==========================================
# 1) è®€å–ç’°å¢ƒè®Šæ•¸ï¼ˆä¸è¦ç¡¬å¯«åœ¨ç¨‹å¼è£¡ï¼‰
# ==========================================
LINE_CHANNEL_TOKEN = os.getenv("LINE_CHANNEL_TOKEN", "").strip()
YOUR_USER_ID = os.getenv("LINE_USER_ID", "").strip()
FINMIND_TOKEN = os.getenv("FINMIND_API_TOKEN", "").strip()

def assert_env():
    missing = []
    if not LINE_CHANNEL_TOKEN:
        missing.append("LINE_CHANNEL_TOKEN")
    if not YOUR_USER_ID:
        missing.append("LINE_USER_ID")
    if not FINMIND_TOKEN:
        missing.append("FINMIND_API_TOKEN")
    if missing:
        print("âŒ ç¼ºå°‘å¿…è¦ç’°å¢ƒè®Šæ•¸ï¼š", ", ".join(missing))
        print("è«‹å…ˆè¨­å®šå¾Œå†åŸ·è¡Œï¼ˆä¸‹é¢æˆ‘æœ‰çµ¦ä½ å¯èªªæ˜çš„è¨­å®šæ–¹å¼ï¼‰ã€‚")
        raise SystemExit(1)

# ==========================================
# 2) LINE Push
# ==========================================
def send_line_push(msg: str):
    url = "https://api.line.me/v2/bot/message/push"
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {LINE_CHANNEL_TOKEN}",
    }
    payload = {
        "to": YOUR_USER_ID,
        "messages": [{"type": "text", "text": msg}],
    }

    try:
        res = requests.post(url, headers=headers, json=payload, timeout=20)
        if res.status_code == 200:
            print("âœ… LINE é€šçŸ¥å·²ç™¼é€æˆåŠŸï¼")
        else:
            print(f"âŒ LINE ç™¼é€å¤±æ•—: {res.status_code} - {res.text}")
    except Exception as e:
        print(f"âŒ LINE é€£ç·šéŒ¯èª¤: {e}")

# ==========================================
# 3) åˆ†æå™¨
# ==========================================
class ProAnalyzer:
    def __init__(self, finmind_token: str):
        self.dl = DataLoader()
        # âœ… æ˜ç¢ºç™»å…¥ FinMindï¼ˆä½  v2 log é‚£æ®µå°±æ˜¯é€™å€‹ï¼‰
        self.dl.login_by_token(finmind_token)

    def analyze_stock(self, stock_id: str, stock_name: str):
        print(f"ğŸš€ æ­£åœ¨åˆ†æ: {stock_name} ({stock_id})...")
        try:
            end_date = datetime.now().strftime("%Y-%m-%d")
            start_date = (datetime.now() - timedelta(days=180)).strftime("%Y-%m-%d")

            df = self.dl.taiwan_stock_daily(
                stock_id=stock_id,
                start_date=start_date,
                end_date=end_date
            )

            if df is None or df.empty:
                print(f"âŒ æŸ¥ç„¡æ•¸æ“š: {stock_name}")
                return None

            # ç¢ºä¿æ¬„ä½æ’åºï¼ˆFinMind é€šå¸¸æœƒæœ‰ date/closeï¼‰
            df = df.sort_values("date").reset_index(drop=True)

            # æŠ€è¡“æŒ‡æ¨™
            df.ta.rsi(length=14, append=True)
            df.ta.macd(fast=12, slow=26, signal=9, append=True)

            latest = df.iloc[-1]
            date_str = str(latest["date"])
            close = float(latest["close"])

            rsi = float(latest["RSI_14"]) if not pd.isna(latest["RSI_14"]) else 50.0
            macd = float(latest["MACD_12_26_9"]) if not pd.isna(latest["MACD_12_26_9"]) else 0.0
            signal = float(latest["MACDs_12_26_9"]) if not pd.isna(latest["MACDs_12_26_9"]) else 0.0

            # è©•åˆ†
            score = 5.0
            reasons = []

            if rsi > 80:
                score -= 2.0
                reasons.append(f"âš ï¸ RSIéç†±({rsi:.0f})")
            elif rsi < 30:
                score += 2.0
                reasons.append(f"ğŸ’ RSIè¶…è³£({rsi:.0f})")
            elif rsi > 60:
                score += 0.5
                reasons.append(f"ğŸ“ˆ å‹•èƒ½å¼·({rsi:.0f})")
            else:
                reasons.append(f"RSI({rsi:.0f})")

            if macd > signal:
                score += 1.5
                reasons.append("ğŸ‚ MACDé‡‘å‰")
            else:
                score -= 1.5
                reasons.append("ğŸ» MACDæ­»å‰")

            score = max(1.0, min(10.0, score))

            if score >= 7.5:
                rec = "ğŸŸ¢ å¼·åŠ›è²·é€²"
            elif score >= 6.0:
                rec = "ğŸ”µ åå¤šæ“ä½œ"
            elif score <= 3.5:
                rec = "ğŸ”´ å»ºè­°è³£å‡º"
            else:
                rec = "ğŸŸ¡ è§€æœ›æŒæœ‰"

            return {
                "name": stock_name,
                "id": stock_id,
                "date": date_str,
                "price": close,
                "score": score,
                "rec": rec,
                "reasons": " ".join(reasons),
            }

        except Exception as e:
            print(f"âŒ åˆ†æéŒ¯èª¤: {stock_name} - {e}")
            return None

# ==========================================
# 4) ä¸»ç¨‹å¼
# ==========================================
def main():
    assert_env()

    print("\n" + "=" * 40)
    print("  è«è€å¸« AI è‚¡å¸‚æ—¥å ± v3.0 (LINE Pushç‰ˆ)")
    print("=" * 40 + "\n")

    my_portfolio = [
        ("2330", "å°ç©é›»"),
        ("2317", "é´»æµ·"),
        ("2603", "é•·æ¦®"),
        ("0050", "å…ƒå¤§å°ç£50"),
        ("1303", "å—äº"),
    ]

    analyzer = ProAnalyzer(FINMIND_TOKEN)

    current_date = datetime.now().strftime("%Y-%m-%d")
    line_msg = f"ğŸ“Š ã€è‚¡å¸‚åˆ†ææ—¥å ±ã€‘\nğŸ“… {current_date}\n{'-'*15}\n"

    for stock_id, stock_name in my_portfolio:
        res = analyzer.analyze_stock(stock_id, stock_name)
        if res:
            line_msg += f"\nğŸ“Œ {res['name']} ({res['id']})\n"
            line_msg += f"æ”¶ç›¤: {res['price']:.2f} ({res['rec']})\n"
            line_msg += f"è©•åˆ†: {res['score']:.1f} | {res['reasons']}\n"
        time.sleep(1)

    line_msg += f"\n{'-'*15}\nğŸ’¡ æŠ•è³‡é¢¨éšªè«‹è‡ªè² "

    print("\n" + line_msg)
    print("\nğŸš€ æ­£åœ¨ç™¼é€ LINE é€šçŸ¥...")
    send_line_push(line_msg)

if __name__ == "__main__":
    main()

